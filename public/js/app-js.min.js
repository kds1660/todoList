var listModule=angular.module("listModule",[]),loginModule=angular.module("loginModule",[]);listModule.controller("listController",["$scope","$rootScope","toastr","moment","listServices",function(e,t,o,s,n){e.list={done:[],todo:[]},n.apiRequest.get().$promise.then(function(t){for(var o=0;o<t.length;o++)t[o].date=n.toLocalTime(t[o].date),t[o].executed?e.list.done.push(t[o]):e.list.todo.push(t[o])},function(e){}),e.executeTask=function(t){n.apiRequest.save({task:e.list.todo[t].id,execute:1}).$promise.then(function(s){o.success(s.message,"Success"),e.list.todo[t].executed=!0,e.list.done.push(e.list.todo[t]),e.list.todo.splice(t,1)},function(e){o.error(e.data.message,"Error")})},e.removeTask=function(t){n.apiRequest.delete({task:e.list.done[t].id}).$promise.then(function(s){o.success(s.message,"Success"),e.list.done.splice(t,1)},function(e){o.error(e.data.message,"Error")})},e.restoreTask=function(t){n.apiRequest.save({task:e.list.done[t].id,execute:0}).$promise.then(function(s){o.success(s.message,"Success"),e.list.done[t].executed=!1,e.list.todo.push(e.list.done[t]),e.list.done.splice(t,1)},function(e){o.error(e.data.message,"Error")})},e.addTask=function(){e.editText={text:"",date:new Date},n.editElement(e).then(function(){n.apiRequest.save(e.editText).$promise.then(function(t){e.editText.id=t.id,e.editText.date=n.toLocalTime(e.editText.date),o.success(t.message,"Success"),e.list.todo.push(e.editText)},function(e){o.error(e.data.message,"Error")})},function(){})},e.editTask=function(t){e.editText={task:e.list.todo[t].id,text:e.list.todo[t].text},n.editElement(e).then(function(){n.apiRequest.update(e.editText).$promise.then(function(s){o.success(s.message,"Success"),e.list.todo[t].text=e.editText.text},function(e){o.error(e.data.message,"Error")})},function(){})},e.filterList=function(){var e=angular.element(document.querySelector(".filter")).val();""!==e?angular.forEach(angular.element(document.querySelectorAll("li")),function(t){var o=t.querySelector("span").innerText;o.substr(0,e.length)!==e?angular.element(t).css("display","none"):angular.element(t).css("display","block")}):angular.element(document.querySelectorAll("li")).css("display","block")},e.sortList=function(t){function o(e){return function(t,o){return t[e]<o[e]?-1:t[e]>o[e]?1:0}}e.list.done.sort(o(t)),e.list.todo.sort(o(t))}}]),loginModule.controller("loginController",["$scope","$rootScope","$state","toastr","loginServices",function(e,t,o,s,n){e.loginUser={},n.apiRequest.get({user:"logged"}).$promise.then(function(t){n.setUser(t.message),e.userName=n.getUser(),n.getUser()?o.go("logged"):o.go("login")}),e.login=function(){n.apiRequest.save(e.loginUser).$promise.then(function(e){s.success(e.message,"Success"),o.go("logged")},function(e){s.error(e.data.message,"Error")})},e.register=function(){e.loginUser.name&&e.loginUser.password?n.apiRequest.update(e.loginUser).$promise.then(function(e){s.success(e.message,"Success")},function(e){s.error(e.data.message,"Error")}):s.error("Set name/password","Error")},e.logout=function(){n.apiRequest.get({user:"logout"}).$promise.then(function(e){s.success(e.message,"Success"),n.setUser(""),o.go("login")},function(e){s.error(e.data.message,"Error")})}}]),listModule.factory("listServices",["$resource","$http","$q","$uibModal","moment",function(e,t,o,s,n){return{apiRequest:e("/api/tasks/:task",{task:"@task"},{update:{method:"put"},get:{isArray:!0}}),editElement:function(e){var n=o.defer();return t.get("templates/editModal.html").then(function(t){s.open({animation:!0,template:t.data,scope:e}).result.then(function(){n.resolve()},function(){n.reject()})}),n.promise},toLocalTime:function(e){return n.utc(e).local().format("LLLL")}}}]),loginModule.factory("loginServices",["$resource",function(e){var t="";return{apiRequest:e("/api/users/:user",{user:"@user"},{update:{method:"put"}}),setUser:function(e){t=e},getUser:function(){return t}}}]),listModule.directive("listElement",function(){return{restrict:"E",templateUrl:"templates/listElement.html",scope:!1}}),loginModule.directive("loginElement",function(){return{restrict:"E",templateUrl:"templates/login.html",scope:!1,link:function(e,t){t[0].addEventListener("keyup",function(t){var o=t.which||t.keyCode;13==o&&e.login()})}}}),angular.module("listRoutes",["ui.router"]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,o){e.state("login",{url:"/login",views:{"":{template:""},"login@login":{template:"<login-element></login-element>",controller:"loginController"},"list@login":{template:"<h1>Not Logged</h1>"}}}).state("logged",{url:"/logged",views:{"":{template:""},"login@logged":{templateUrl:"templates/logged.html",controller:"loginController"},"list@logged":{templateUrl:"templates/list.html",controller:"listController"}}}),o.html5Mode({enabled:!0,requireBase:!1}),t.otherwise("/login")}]);var app=angular.module("todoListApp",["ui.router","ui.bootstrap","angularMoment","ngAnimate","toastr","ngResource","listRoutes","listModule","loginModule"]);